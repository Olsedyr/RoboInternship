STATEMACHINEVERSION 2
Name=UniChain
Delaystop=5000000
Input=0,Full "KassePakker conveyorFull"
Input=1,Printstop "PrinterStop"
Input=2,Endestop "ConveyorIn endestop"
Output=0,Motor "UniChain Motor"
Output=1,Stopflow "stopFlowPakker"
Link=0,KassePakkerTop
Link=1,PladsLoad
Link=2,Plads3
Link=3,Plads4
Link=4,Plads5
Link=5,SkumKlap
Timeout=0,StopDelay 40000
Timeout=1,StartDelay 50000
Timeout=2,WaitStop 7000000
Timeout=3,BeginDelay 2000000
Value=0,message 0
Value=1,Countnum 0
Value=2,Countnoprod 0 
Value=3,Countdown 0
Value=4,Countmax 35
Value=5,Countmaxdown 20
Value=6,one 1
Value=7,forcedIdle 1
Value=8,Countnoprodmax 250
Value=9,valmanuel 0

State=0,ST_TIMER
END

State=0,ST_HALT
END

State=0,ST_IDLE
  SET message 0
  SET Stopflow 1	
  TEST forcedIdle = one 
    SET forcedIdle 0
    TIMEOUT WaitStop ST_IDLE
    SETSTATE ST_IDLE
  ELSE
    TEST WaitStop = 1
      SET Motor 0
    ENDTEST
  ENDTEST
END

State=1,ST_RUN
  SET message 0
  SET Stopflow 0
  SET Countdown 0
  SET Motor 1
  TEST Countnum >= Countmax
    SETSTATE ST_STOP
  ELSE
    TIMEOUT StopDelay ST_COUNTUP
    SETSTATE ST_COUNTUP
  ENDTEST
  TEST PladsLoad = ST_EMPTY
  AND Plads3 = ST_EMPTY
  AND Plads4 = ST_EMPTY
  AND Plads5 = ST_EMPTY
    SETSTATE ST_NOBOXES
  ENDTEST
  TEST Printstop = 1
    SETSTATE ST_STOP
  ENDTEST
  TEST SkumKlap = ST_IDLE
    SET forcedIdle 1
    SETSTATE ST_IDLE
  ENDTEST
END

State=1,ST_COUNTUP
 TEST StopDelay = 1
   TEST Full = 1
     SET Countnoprod 0
     ADD Countnum one Countnum
   ELSE
     ADD Countnoprod one Countnoprod
     SET Countnum 0
   ENDTEST
   SETSTATE ST_RUN
   TEST Countnoprod >= Countnoprodmax
     SETSTATE ST_NOPRODUCTS
   ENDTEST
 ENDTEST
END

State=1,ST_NOPRODUCTS
  SET message 2000
  TEST Full = 1
    SETSTATE ST_RUN
  ENDTEST
  TEST PladsLoad = ST_EMPTY
  AND Plads3 = ST_EMPTY
  AND Plads4 = ST_EMPTY
  AND Plads5 = ST_EMPTY
    SETSTATE ST_NOBOXES
  ENDTEST
  TEST Printstop = 1
    SETSTATE ST_STOP
  ENDTEST
  TEST SkumKlap = ST_IDLE
    SET forcedIdle 1
    SETSTATE ST_IDLE
  ENDTEST
END

State=1,ST_NOBOXES
  SET message 2003
  SET Stopflow 1
  TEST PladsLoad != ST_EMPTY
    SETSTATE ST_RUN
  ENDTEST
  TEST Printstop = 1
    SETSTATE ST_STOP
  ENDTEST
  TEST SkumKlap = ST_IDLE
    SET forcedIdle 1
    SETSTATE ST_IDLE
  ENDTEST
END

State=2,ST_STOP
  SET Stopflow 1
  SET Countnum 0
  TEST Countdown >= Countmaxdown
    TEST Printstop = 0
      SETSTATE ST_RUN
    ENDTEST
  ELSE
    TIMEOUT StartDelay ST_COUNTDOWN
    SETSTATE ST_COUNTDOWN
  ENDTEST
  TEST Printstop = 1
    SET message 2001
    SET Motor 0
  ELSE
    SET Motor 1
    SET message 2002
  ENDTEST
  TEST SkumKlap = ST_IDLE
    SET forcedIdle 1
    SETSTATE ST_IDLE
  ENDTEST 
END

State=1,ST_COUNTDOWN
 TEST StartDelay = 1
   TEST Full = 0
     ADD Countdown one Countdown
   ELSE
     SET Countdown 0
   ENDTEST
   SETSTATE ST_STOP
 ENDTEST
END

State=5,ST_RESET
  TEST Endestop = 0
    SET Motor 0
    TIMEOUT BeginDelay ST_RESTART
    SETSTATE ST_RESTART
  ELSE
    TEST valmanuel = one
      SETSTATE ST_MANUEL
    ELSE
      SETSTATE ST_MAN_NORUN
    ENDTEST
  ENDTEST
END

State=5,ST_RESET_MANRUN
  SET valmanuel 1
END

State=5,ST_RESET_MANSTOP
  SET valmanuel 0
END

State=5,ST_MANUEL
  SET Stopflow 0
  SET Motor 1
END

State=5,ST_MAN_NORUN
  SET Stopflow 1
  SET Motor 0
  TEST SkumKlap = ST_IDLE
    SET forcedIdle 1
    SETSTATE ST_IDLE
  ENDTEST
END

State=5,ST_RESTART
  TEST BeginDelay = 1
    SET message 0
    SET Countnum 0
    SET Countnoprod 0
    SET Countdown 0
    SET Motor 1
    SET Stopflow 1
    SET forcedIdle 1
    SETSTATE ST_STOP
  ENDTEST
END

