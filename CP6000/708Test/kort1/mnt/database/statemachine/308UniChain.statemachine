STATEMACHINEVERSION 2
Name=UniChain
Delaystop=5000000
Input=0,Full "KassePakker conveyorFull"
Input=1,Printstop "PrinterStop"
Output=0,Motor "KassePakker bufferPladsMotor"
Output=1,uniMotor "KassePakker UniChainMotor"
Output=2,Stopflow "stopFlowPakker"
Link=0,KassePakkerTop
Link=1,PladsLoad
Link=2,Plads3
Link=3,Plads4
Link=4,Plads5
Timeout=0,StopDelay 20000
Timeout=1,StartDelay 20000
Timeout=2,WaitStop 4000000
Timeout=3,BeginDelay 2000000
Value=0,message 0
Value=1,Countnum 0
Value=2,Countnoprod 0 
Value=3,Countdown 0
Value=4,Countmax 90
Value=5,Countmaxdown 20
Value=6,Count1 1
Value=7,forcedIdle 1
Value=8,Countnoprodmax 200

State=0,ST_TIMER
END

State=0,ST_HALT
END

State=0,ST_IDLE
  SET message 0
  SET Stopflow 1	
  TEST forcedIdle = Count1
    SET forcedIdle 0
    TIMEOUT WaitStop ST_IDLE
    SETSTATE ST_IDLE
  ELSE
    TEST WaitStop = 1
      SET Stopflow 0	
      SET Motor 0
      SET uniMotor 0
    ENDTEST
  ENDTEST
END

State=1,ST_RUN
  TEST PladsLoad = ST_EMPTY
  AND Plads3 = ST_EMPTY
  AND Plads3 = ST_EMPTY
  AND Plads3 = ST_EMPTY
    SET message 2003
  ELSE
    SET message 0
  ENDTEST
  SET Stopflow 0
  SET Countdown 0
  SET Motor 1
  SET uniMotor 1
  TEST Countnum >= Countmax
    SETSTATE ST_STOP
  ELSE
    TIMEOUT StopDelay ST_COUNTUP
    SETSTATE ST_COUNTUP
  ENDTEST
  TEST Printstop = 1
    SETSTATE ST_STOP
  ENDTEST
  TEST KassePakkerTop = ST_IDLE
    SETSTATE ST_IDLE
  ENDTEST
END

State=1,ST_COUNTUP
 TEST StopDelay = 1
   TEST Full = 1
     SET Countnoprod 0
     ADD Countnum Count1 Countnum
   ELSE
     ADD Countnoprod Count1 Countnoprod
     SET Countnum 0
   ENDTEST
   SETSTATE ST_RUN
   TEST Countnoprod >= Countnoprodmax
     SETSTATE ST_NOPRODUCTS
   ENDTEST
 ENDTEST
END

State=1,ST_NOPRODUCTS
  SET message 2000
  TEST Full = 1
    SETSTATE ST_RUN
  ENDTEST
  TEST Printstop = 1
    SETSTATE ST_STOP
  ENDTEST
  TEST KassePakkerTop = ST_IDLE
    SETSTATE ST_IDLE
  ENDTEST
END

State=2,ST_STOP
  SET Stopflow 1
  SET Countnum 0
  TEST Countdown >= Countmaxdown
    TEST Printstop = 0
      SETSTATE ST_RUN
    ENDTEST
  ELSE
    TIMEOUT StartDelay ST_COUNTDOWN
    SETSTATE ST_COUNTDOWN
  ENDTEST
  TEST Printstop = 1
    SET message 2001
    SET Motor 0
    SET uniMotor 0
  ELSE
    SET Motor 1
    SET uniMotor 1
    SET message 2002
  ENDTEST
  TEST KassePakkerTop = ST_IDLE
    SETSTATE ST_IDLE
  ENDTEST 
END

State=1,ST_COUNTDOWN
 TEST StartDelay = 1
   TEST Full = 0
     ADD Countdown Count1 Countdown
   ELSE
     SET Countdown 0
   ENDTEST
   SETSTATE ST_STOP
 ENDTEST
END

State=5,ST_RESET
  SET Motor 0
  SET uniMotor 0
  SET forcedIdle 1
  TIMEOUT BeginDelay ST_RESTART
  SETSTATE ST_RESTART
END

State=5,ST_RESTART
  TEST BeginDelay = 1
    SET message 0
    SET Countnum 0
    SET Countnoprod 0
    SET Countdown 0
    SET Motor 1
    SET uniMotor 1
    SET Stopflow 1
    SETSTATE ST_STOP
  ENDTEST
END

