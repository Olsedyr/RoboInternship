STATEMACHINEVERSION 3
Name=PS
Delaystop=5000000
Input=fotoFri1 "PS foto1"
Input=fotoFri2 "PS foto2"
Input=fotoFri3 "PS foto3"
Input=switchTop "PS switchTop"
Input=fotoBottom "PS fotoBottom"
Output=up "PS up"
Output=down "PS down"
Output=soft "PS soft"
Link=WorkCell
Link=program Program304
Link=parent PallebanePS
Link=robotprg1 ProgramNS
Link=robotprg2 ProgramHP
Timeout=timeoutForSoft 100000
Timeout=timeBeforeReset 3000000
Value=errorCode 0
Value=lastFotoFreeMM 450
linkValue=counterMM PScounter
linkValue=activeProgram activeProgram program
Const=mmFotoFree 42
Const=bottomMM 670
Const=halfPalletPositionMM 1000
Value=layer 0
Value=freeMM 0
;signals from other stm
Value=moveBottom 0
Value=moveUp 0
Value=moveTop 0
Value=simulate 0

State=ST_TIMER
 END

State=ST_HALT
 END

State=ST_IDLE
  SET soft 0
  SET up 0
  SET down 0
  TEST parent = ST_RESET
    SET errorCode 0
    SETSTATE ST_RESET
  ENDTEST
END

State=ST_RESET
;TEST that robot is gone
	TEST robotprg1 = ST_HOME
	OR robotprg2 = ST_HOME
	OR simulate = 2
    SET soft 1
    SET up 1
    SETSTATE ST_RESET_WAIT_UNTIL_TOP1
  ENDTEST
 END

State=ST_RESET_WAIT_UNTIL_TOP1
  TEST switchTop = 1
  OR simulate = 1
    SET soft 0
    SET up 0
    TIMEOUT timeoutForSoft ST_RESET_WAIT_UNTIL_TOP1_TIMEOUT
    SETSTATE ST_TIMER
  ENDTEST
 END

State=ST_RESET_WAIT_UNTIL_TOP1_TIMEOUT
	SET soft 1
	SET down 1
	SETSTATE ST_RESET_WAIT_UNTIL_DOWN
 END

State=ST_RESET_WAIT_UNTIL_DOWN
  TEST switchTop = 0
    SET soft 0
    SET down 0 
    TIMEOUT timeoutForSoft ST_RESET_WAIT_UNTIL_DOWN_TIMEOUT
    SETSTATE ST_TIMER
  ENDTEST
 END

State=ST_RESET_WAIT_UNTIL_DOWN_TIMEOUT
	SET soft 1
	SET up 1
	SETSTATE ST_RESET_WAIT_UNTIL_TOP2
 END

State=ST_RESET_WAIT_UNTIL_TOP2
  TEST switchTop = 1
  OR simulate = 1
    SET soft 0
    SET up 0
    SET moveTop 0
    SET moveBottom 0
    SET moveUp 0
    TIMEOUT timeoutForSoft ST_TOP
    SETSTATE ST_TIMER
  ENDTEST
 END

State=ST_TOP
  TEST moveBottom = 1
    SETSTATE ST_MOVE_TO_BOTTOM
  ENDTEST
END

State=ST_MOVE_TO_BOTTOM
	SET soft 1
	SET down 1
  TEST activeProgram = 0
  	SETSTATE ST_WAIT_UNTIL_BOTTOM
  ELSE
  	SETSTATE ST_WAIT_UNTIL_HP_POS
  ENDTEST
 END

State=ST_WAIT_UNTIL_HP_POS
  TEST counterMM <= halfPalletPositionMM
    SET soft 0
    SET down 0
    TIMEOUT timeoutForSoft ST_CALG_HP
    SETSTATE ST_TIMER
  ENDTEST
END

State=ST_CALG_HP
  TEST simulate = 1
    CALC lastFotoFreeMM = lastFotoFreeMM + 1
  ELSE
    SET lastFotoFreeMM counterMM
  ENDTEST
  SET layer 0
  SET moveTop 0
  SET moveBottom 0
  SET moveUp 0
  SETSTATE ST_HP_READY
END

State=ST_HP_READY
  TEST moveTop = 1
    SETSTATE ST_RESET
  ENDTEST
 END

State=ST_WAIT_UNTIL_BOTTOM
  TEST counterMM <= bottomMM
  OR fotoBottom = 0 
    SET soft 0
    SET down 0
    TIMEOUT timeoutForSoft ST_CALG_BOTTOM
    SETSTATE ST_TIMER
  ENDTEST
END

State=ST_CALG_BOTTOM
  TEST simulate = 1
    CALC lastFotoFreeMM = lastFotoFreeMM + 1
  ELSE
    SET lastFotoFreeMM counterMM
  ENDTEST
  SET layer 0
  SET moveTop 0
  SET moveBottom 0
  SET moveUp 0
  SETSTATE ST_FOTO_FRI
END

State=ST_MOVE_FOTO_FRI
  TEST fotoFri1 = 0
  AND fotoFri2 = 0
  AND fotoFri3 = 0
    SET moveTop 0
    SET moveBottom 0
    SET moveUp 0
    TIMEOUT timeoutForSoft ST_CALC_FOTO_FRI
    SETSTATE ST_CALC_FOTO_FRI
  ELSE
  	SET soft 1
	  SET up 1
	  SETSTATE ST_WAIT_UNTIL_FOTO_FRI
  ENDTEST
 END

State=ST_WAIT_UNTIL_FOTO_FRI
  TEST switchTop = 1
    SET soft 0
    SET up 0
    SET errorCode 2200
    SETSTATE ST_IDLE
  ELSE
    TEST fotoFri1 = 0
    AND fotoFri2 = 0
    AND fotoFri3 = 0
      CALC freeMM = counterMM + mmFotoFree
      SETSTATE ST_WAIT_UNTIL_FOTO_FRI_TICKS
    ENDTEST
  ENDTEST
 END

State=ST_WAIT_UNTIL_FOTO_FRI_TICKS
  TEST switchTop = 1
    SET soft 0
    SET up 0
    SET errorCode 2201
    SETSTATE ST_IDLE
  ELSE
    TEST counterMM >= freeMM 
    OR simulate = 1 
      SET soft 0
      SET up 0
      TIMEOUT timeoutForSoft ST_CALC_FOTO_FRI
      SETSTATE ST_TIMER
    ENDTEST
  ENDTEST
END

State=ST_CALC_FOTO_FRI
  TEST simulate = 1
    CALC lastFotoFreeMM = lastFotoFreeMM + 1
  ELSE
    SET lastFotoFreeMM counterMM
  ENDTEST
  CALC layer = layer + 1
  SETSTATE ST_FOTO_FRI
 END

State=ST_FOTO_FRI
  TEST moveUp = 1
    SETSTATE ST_MOVE_FOTO_FRI
  ENDTEST
  TEST moveTop = 1
    SETSTATE ST_RESET
  ENDTEST
 END

