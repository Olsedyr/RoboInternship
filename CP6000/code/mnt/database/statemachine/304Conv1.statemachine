STATEMACHINEVERSION 3
Name=Conv1
Link=foto1 Conv1Foto1
Link=foto2 Conv1Foto2
Output=Motor "ConveyorOut motor"
Link=prev Conv2
Link=parent Parent
;Time for case/product to leave conveyor after foto has gone free
Timeout=freeWaitTime 0
Timeout=startupTime 5000000
Timeout=maxReceiveTime 10000000
Timeout=StopDelay 0
Timeout=EmptyDelay 0
Timeout=maxSendTime 200000000
Timeout=timeBeforeReset 1000000
Value=sendAndWait 0
Const=lengthMM 1600.0
Const=speedMS 0.6
Value=simulate 0
Value=errorCode 0
Value=timelength 0.0
Value=moveBag 0

;en transportør går automatisk fra ready til empty hvis fotocelle slukker
;og fra empty til ready hvis fotocelle tænder

State=ST_TIMER
END

State=ST_HALT
END

State=ST_IDLE
  SET Motor 0
	TEST parent = ST_RESET
  OR simulate = 1
    SET errorCode 0
		SETSTATE ST_RESET
	ENDTEST
END

State=ST_READY_ROBOT
  TEST foto1 = ST_FREE
;  AND foto2 = ST_FREE 
    TEST simulate = 0
      SET errorCode 5000 
      SETSTATE ST_IDLE
    ELSE
      TEST moveBag = 1
        SET moveBag 2
        TIMEOUT maxSendTime ST_SEND
        SETSTATE ST_SEND
      ELSE 
        SET Motor 0
      ENDTEST
    ENDTEST
  ELSE
    TEST moveBag = 1
      SET moveBag 2
      TIMEOUT maxSendTime ST_SEND
      SETSTATE ST_SEND
    ELSE 
      SET Motor 0
    ENDTEST
  ENDTEST
  TEST parent = ST_IDLE
  AND simulate = 0
    SETSTATE ST_IDLE
  ENDTEST
END

State=ST_SEND
  TEST sendAndWait = 1
    TEST freeWaitTime = 1
      SET sendAndWait 0
      SET moveBag 3
      SETSTATE ST_EMPTY
    ENDTEST
  ELSE
    TEST maxSendTime = 1
      SET moveBag 3
      TIMEOUT timeBeforeReset ST_RESET
      SETSTATE ST_TIMER
    ELSE
      SET Motor 1
      TEST foto1 = ST_FREE
;     AND foto2 = ST_FREE
        SET sendAndWait 1
        TIMEOUT freeWaitTime ST_SEND
        SETSTATE ST_SEND
      ENDTEST
   ENDTEST
 ENDTEST
END

State=ST_EMPTY
  TEST prev = ST_SEND
    TIMEOUT maxReceiveTime ST_RECEIVE
    SETSTATE ST_RECEIVE
  ELSE 
    TEST foto1 = ST_BLOCKED
;   OR foto2 = ST_BLOCKED
      TIMEOUT StopDelay ST_READY_ROBOT
      SETSTATE ST_TIMER
    ELSE
      SET Motor 0
    ENDTEST
  ENDTEST
  TEST simulate = 1
		SETSTATE ST_READY_ROBOT
	ENDTEST
  TEST parent = ST_IDLE
  AND simulate = 0
    SETSTATE ST_IDLE
  ENDTEST
END

State=ST_RECEIVE
  TEST foto1 = ST_BLOCKED
; OR foto2 = ST_BLOCKED
    TIMEOUT StopDelay ST_READY_ROBOT
    SETSTATE ST_TIMER
  ELSE
    TEST maxReceiveTime = 1
      SETSTATE ST_RESET
    ELSE
      TEST prev = ST_SEND
        SET Motor 1
      ENDTEST
    ENDTEST
  ENDTEST
END

State=ST_RESET
  TEST foto1 = ST_BLOCKED
; OR foto2 = ST_BLOCKED
		SETSTATE ST_READY_ROBOT
	ELSE
    CALC timelength = lengthMM / speedMS 
    ;*1500 = kør bånd 1.5 gang igennem for at finde produkt
    CALC timelength = timelength * 1500
    SET startupTime timelength
    TIMEOUT startupTime ST_STARTUP
    SETSTATE ST_STARTUP
	ENDTEST
  TEST simulate = 1
		SETSTATE ST_READY_ROBOT
	ENDTEST
END


State=ST_STARTUP
  TEST foto1 = ST_BLOCKED 
; OR foto2 = ST_BLOCKED
    SETSTATE ST_READY_ROBOT
  ELSE
    TEST startupTime = 1
      SETSTATE ST_EMPTY
    ELSE
      SET Motor 1
    ENDTEST
  ENDTEST
END
