STATEMACHINEVERSION 3
Name=PindeTjekker400
Output=motor "PindeTjekker400 Motor"
Output=pushup "PindeTjekker400 Push Up Ventil"
Output=pushin "PindeTjekker400 Push In Ventil"
Output=pushout "PindeTjekker400 Push Out Ventil"
Output=squeezer "PindeTjekker400 Squeezer Ventil"
Output=stopper "PindeTjekker400 Case Stopper Ventil"
Output=syncOut "extern syncOut"
Link=foto PindeTjekker400Foto
Link=next ConveyorOut2
linkValue=casekind Program314
Timeout=squeezeTime 1300000
Timeout=unSqueezeTime 300000
Timeout=pushupTime 500000
Timeout=pushinTime 400000
Timeout=stopperTime 400000
Timeout=openStopperTime 700000
Timeout=maxSendTime 15000000
Timeout=maxReceiveTime 15000000
Value=errorCode 0
Link=parent Parent
Const=maxPushIn 2
Const=maxPushUp 2
Value=pushInNum 0
Value=pushUpNum 0
Value=simulate 0

;casekind = 6  -> Netto

State=ST_TIMER
END

State=ST_HALT
END

State=ST_IDLE
  SET motor 0
  SET pushup 0
  SET pushin 0
  SET pushout 0
  SET squeezer 0
  SET stopper 0
	SET syncOut 0	
  TEST parent = ST_RESET
  OR simulate = 1
    SET errorCode 0
    SETSTATE ST_RESET
  ENDTEST
END

State=ST_RESET
  TEST foto = ST_BLOCKED
    SETSTATE ST_STARTUP
  ELSE
    SETSTATE ST_GET
  ENDTEST
END

State=ST_STARTUP
  TEST casekind = 6
    SET stopper 1
    TIMEOUT stopperTime ST_STARTUP2
    SETSTATE ST_STARTUP2
  ELSE
    SETSTATE ST_WAIT_SEND
  ENDTEST
END

State=ST_STARTUP2
  TEST stopperTime = 1
    TEST casekind = 6
      SET motor 1
      SET pushout 1
      SET squeezer 1
      TIMEOUT squeezeTime ST_SQUEEZING
      SETSTATE ST_SQUEEZING
    ENDTEST
  ENDTEST
END

State=ST_GET
	SET syncOut 1
  SET motor 1
  TEST casekind = 6
    SET stopper 1
  ELSE
    SET stopper 0
  ENDTEST
  TEST foto = ST_BLOCKED
		SET syncOut 0
    TEST casekind = 6
		  SET motor 1
      SET pushout 1
      TIMEOUT stopperTime ST_READY
      SETSTATE ST_READY
    ELSE
      SETSTATE ST_WAIT_SEND
    ENDTEST
  ELSE
		TEST parent = ST_IDLE
		AND simulate = 0
			SETSTATE ST_IDLE
		ENDTEST  
  ENDTEST
END

State=ST_READY
  TEST stopperTime = 1
    SET motor 0
    SET squeezer 1
    TIMEOUT squeezeTime ST_SQUEEZING
    SETSTATE ST_SQUEEZING
  ENDTEST
END

State=ST_SQUEEZING
  TEST squeezeTime = 1
    SET stopper 0
    TIMEOUT openStopperTime ST_OPEN_STOPPER
    SETSTATE ST_OPEN_STOPPER
  ENDTEST
END

State=ST_OPEN_STOPPER
  TEST openStopperTime = 1
    SET pushup 1
    TIMEOUT pushupTime ST_PUSHING_UP
    SETSTATE ST_PUSHING_UP
  ENDTEST
END

State=ST_PUSHING_UP
  TEST pushupTime = 1
    CALC pushUpNum = pushUpNum + 1
    TEST pushUpNum >= maxPushUp
      SET pushout 0
      SET pushin 1
      SET pushUpNum 0
      TIMEOUT pushinTime ST_PUSHING_IN
      SETSTATE ST_PUSHING_IN
    ELSE
      SET pushup 0
      TIMEOUT pushupTime ST_PUSH_UP_BACK_EXTRA
      SETSTATE ST_PUSH_UP_BACK_EXTRA
    ENDTEST
  ENDTEST
END

State=ST_PUSH_UP_BACK_EXTRA
  TEST pushupTime = 1
    SET pushup 1
    TIMEOUT pushupTime ST_PUSHING_UP
    SETSTATE ST_PUSHING_UP
  ENDTEST
END

State=ST_PUSHING_IN
  TEST pushinTime = 1
    CALC pushInNum = pushInNum + 1
    TEST pushInNum >= maxPushIn
			SET pushInNum 0
			SET pushup 0
			TIMEOUT pushupTime ST_PUSH_UP_BACK
			SETSTATE ST_PUSH_UP_BACK
		ELSE
			SET pushout 1
			SET pushin 0
			TIMEOUT pushinTime ST_PUSH_IN_BACK
			SETSTATE ST_PUSH_IN_BACK
		ENDTEST
  ENDTEST
END

State=ST_PUSH_IN_BACK
  TEST pushinTime = 1
    SET pushout 0
    SET pushin 1
    TIMEOUT pushinTime ST_PUSHING_IN
    SETSTATE ST_PUSHING_IN
  ENDTEST
END

State=ST_PUSH_UP_BACK
	TEST pushupTime = 1
		SET pushout 1
		SET pushin 0
		TIMEOUT pushinTime ST_PUSHING_OUT
		SETSTATE ST_PUSHING_OUT
	ENDTEST
END

State=ST_PUSHING_OUT
  TEST pushinTime = 1
    SET squeezer 0
    TIMEOUT unSqueezeTime ST_UNSQUEEZE
    SETSTATE ST_UNSQUEEZE
  ENDTEST
END

State=ST_UNSQUEEZE
  TEST unSqueezeTime = 1
    SET stopper 0
    SETSTATE ST_WAIT_SEND
  ENDTEST
END

State=ST_WAIT_SEND
  TEST next = ST_EMPTY
    TIMEOUT maxSendTime ST_SEND
    SETSTATE ST_SEND
  ELSE
    SET motor 0
  ENDTEST
  TEST foto = ST_FREE
    SETSTATE ST_GET
  ENDTEST
  TEST parent = ST_IDLE
  AND simulate = 0
    SETSTATE ST_IDLE
  ENDTEST
END

State=ST_SEND
  TEST next = ST_RECEIVE
    SET motor 1
	ELSE
		TEST next = ST_GET
			SETSTATE ST_GET
		ENDTEST
  ENDTEST
  TEST maxSendTime = 1
    SET errorCode 4116
    SETSTATE ST_IDLE
  ENDTEST
END
