STATEMACHINEVERSION 3
Name=ProductCount
;** Input **
;** Output **
;** Link **
Link=Skubber LangBufferSkub
Link=CamGenSkub
Link=parent Parent
Link=KasseLift
Link=lfoto1 Product1Foto1
Link=lfoto2 Product1Foto2
Link=rfoto1 Product2Foto1
Link=rfoto2 Product2Foto2
Link=PushPattern
Link=Conveyors ProductConveyors
;** linkValue **
linkValue=lfoto1test test lfoto1
linkValue=lfoto2test test lfoto2
linkValue=rfoto1test test rfoto1
linkValue=rfoto2test test rfoto2
linkValue=curpm CamGenSkub
linkValue=curppp PushPattern
linkValue=productsfromleft Program
linkValue=productsfromright Program
linkValue=firstRun WorkCell
linkValue=manuelt Program
linkValue=doFakeProducts WorkCell
;** Table **
;** Item **
;** Const **
Const=freepmstay 350
Const=freepmforward 200
;** Value **
Value=errorCode 0
Value=message 0
Value=numofproducts 0
Value=prenumofproducts 0
Value=totcount 0
Value=lowcount 0
Value=pushtotcount 0
Value=pushing 0
Value=oldppp 0
Value=timeStopOn 0
;** Timeout **
Timeout=fakeProductRate 2000000
Timeout=TimeStartUp 1500000
Timeout=maxProductLengthStopTime 2000000
Timeout=TimeStop 1000000

State=ST_TIMER
END

State=ST_HALT
END

State=ST_IDLE
	TEST parent = ST_RESET
		SETSTATE ST_RESET
	ENDTEST
END

State=ST_RESET
	SET errorCode 0
	SET numofproducts 0
	SET totcount 0
	SET lowcount 0
	SET pushtotcount 0
	TEST firstRun = 1		
		TIMEOUT TimeStartUp ST_STARTUP
		SETSTATE ST_STARTUP
	ELSE
    TIMEOUT fakeProductRate ST_RUN
    SETSTATE ST_RUN
	ENDTEST
END

State=ST_STARTUP
  SET oldppp curppp
	TEST TimeStartUp = 1
    TIMEOUT fakeProductRate ST_RUN
		SETSTATE ST_RUN
    TEST productsfromleft = 1
    AND productsfromright = 1
      TEST lfoto1test = 0
			OR lfoto2test = 0
			OR rfoto1test = 0
			OR rfoto2test = 0
				SET errorCode 1055
				SETSTATE ST_IDLE
			ENDTEST
			SET numofproducts 0
			SET totcount 0
			SET pushtotcount 0
		  SET prenumofproducts numofproducts
    ELSE
		  TEST productsfromleft = 1
			  TEST lfoto1test = 0
			  OR lfoto2test = 0
				  SET errorCode 1055
				  SETSTATE ST_IDLE
			  ENDTEST
			  SET numofproducts 0
			  SET totcount 0
			  SET pushtotcount 0
		    SET prenumofproducts numofproducts
		  ELSE
			  TEST productsfromright = 1
				  TEST rfoto1test = 0
				  OR rfoto2test = 0
					  SET errorCode 1055
					  SETSTATE ST_IDLE
				  ENDTEST
				  SET numofproducts 0
				  SET totcount 0
				  SET pushtotcount 0

				  SET prenumofproducts numofproducts
        ENDTEST
			ENDTEST
		ENDTEST
    TEST manuelt = 1
      SET errorCode 0
      SETSTATE ST_RUN_MANUELT
    ENDTEST
	ENDTEST
END

State=ST_RUN
  TEST lfoto1 = ST_HIGH
  AND productsfromleft = 1
		CALC numofproducts = numofproducts + 1
		SET prenumofproducts numofproducts
		CALC totcount = pushtotcount + numofproducts
		CALC lowcount = lowcount + 1
	ENDTEST
	TEST lfoto1 = ST_LOW
  AND productsfromleft = 1
		CALC prenumofproducts = numofproducts + 1
	ENDTEST
	TEST rfoto1 = ST_HIGH
  AND productsfromright = 1
		CALC numofproducts = numofproducts + 1
		SET prenumofproducts numofproducts
		CALC totcount = pushtotcount + numofproducts
		CALC lowcount = lowcount + 1
	ENDTEST
	TEST rfoto1 = ST_LOW
  AND productsfromright = 1
		CALC prenumofproducts = numofproducts + 1
	ENDTEST
  TEST pushing = 0
	  TEST Skubber = ST_FORWARD
      TEST curpm > freepmforward
		    CALC numofproducts = numofproducts - oldppp
		    CALC prenumofproducts = prenumofproducts - oldppp
		    CALC pushtotcount = pushtotcount + oldppp
		    CALC totcount = pushtotcount + numofproducts
        SET oldppp curppp
        SET pushing 1
      ENDTEST
    ELSE
      TEST Skubber = ST_FORWARDSTAY
        TEST curpm > freepmstay
		      CALC numofproducts = numofproducts - oldppp
		      CALC prenumofproducts = prenumofproducts - oldppp
		      CALC pushtotcount = pushtotcount + oldppp
		      CALC totcount = pushtotcount + numofproducts
          SET oldppp curppp
          SET pushing 1
        ENDTEST
      ENDTEST
	  ENDTEST
  ELSE
	  TEST Skubber != ST_FORWARD
	  AND Skubber != ST_FORWARDSTAY
    AND Skubber != ST_STAY_FINISH
      SET pushing 0
	  ENDTEST
  ENDTEST
  TEST doFakeProducts = 1
    TEST fakeProductRate = 1
      CALC numofproducts = numofproducts + 1
		  SET prenumofproducts numofproducts
		  CALC totcount = pushtotcount + numofproducts
		  CALC lowcount = lowcount + 1
      TIMEOUT fakeProductRate ST_RUN
      SETSTATE ST_RUN
    ENDTEST
    TEST KasseLift = ST_READY
			SET numofproducts 0
			SET totcount 0
			SET pushtotcount 0
		  SET prenumofproducts numofproducts
      SET doFakeProducts 0
    ENDTEST
  ENDTEST
	TEST firstRun = 1
	AND parent = ST_RESET
    SET timeStopOn 0
		TIMEOUT TimeStartUp ST_STARTUP
		SETSTATE ST_STARTUP
	ENDTEST
  TEST Conveyors = ST_IDLE
    TEST timeStopOn = 0
      SET timeStopOn 1
      TIMEOUT TimeStop ST_RUN
      SETSTATE ST_RUN
    ELSE
      TEST TimeStop = 1
        SET timeStopOn 0
        SETSTATE ST_NOCOUNT
      ENDTEST
    ENDTEST
  ENDTEST
END

State=ST_NOCOUNT
  TEST parent = ST_RESET
    TEST firstRun = 1
		  TIMEOUT TimeStartUp ST_STARTUP
		  SETSTATE ST_STARTUP
    ELSE
      SETSTATE ST_RUN
    ENDTEST
  ENDTEST
END

State=ST_RUN_MANUELT
  TEST productsfromright = 1
    TEST rfoto1 = ST_OFF
      TEST maxProductLengthStopTime = 1
        ;hack that stops ProductConveyor
        SET prenumofproducts 100
        SET message 1000
      ELSE
        SET prenumofproducts 0
        SET message 0
      ENDTEST
    ELSE
      TEST rfoto1 = ST_ON
        SET prenumofproducts 0
        TIMEOUT maxProductLengthStopTime ST_RUN_MANUELT
        SETSTATE ST_RUN_MANUELT
      ENDTEST
    ENDTEST
  ELSE
    SET prenumofproducts 0
    TIMEOUT maxProductLengthStopTime ST_RUN_MANUELT
    SETSTATE ST_RUN_MANUELT
  ENDTEST
  TEST firstRun = 1
	AND parent = ST_RESET
    SET message 0
		SETSTATE ST_RESET
	ENDTEST
END
