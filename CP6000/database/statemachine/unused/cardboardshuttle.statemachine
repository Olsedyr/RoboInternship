STATEMACHINEVERSION 3
Name=CardBoardShuttle
Output=Lower "CardBoardShuttle Lower"
Output=Suck "CardBoardShuttle Suck"
Input=Photo "CardBoardShuttle Photo"
Input=ShuttleUp "CardBoardShuttle ReadUp"
Input=ShuttleDown "CardBoardShuttle ReadDown"
Input=PhotoTest "CardBoardShuttle PhotoTest"
Link=scissorpick ScissorDepalletizer3_3 
Link=scissorplace ScissorPalletizer3_6 
linkValue=upstep scissorpick
linkValue=downstep scissorplace
linkValue=inTopPos ScissorDepalletizer3_3 
linkValue=pickfinito finito ScissorDepalletizer3_3 
linkValue=placefinito finito ScissorPalletizer3_6 
linkValue=nextpalb Frames
linkValue=Sclimitup test Sc3_3PhotoUpLimit
linkValue=curpm ServoCardBoard
linkValue=axis_t Robot
linkValue=cBItem Frames
linkValue=wBItem Frames
Link=Servo ServoCardBoard
Link=parent Parent
Link=robotprg ProgramB2
Value=errorCode 0
Value=nextcardboardlayer 0
Value=tries 0
Value=testcardboard 0
Value=clearNext 0
Value=oneshot 0
Value=prenextcardboardlayer 0
Value=pickAndWaitNext 0
Value=temp 0
Value=simCardboardOnly 0
Const=maxtries 3
Const=nextcurpm 500
Timeout=TimePick 0
Timeout=TimePickDown 1000000
Timeout=TimePickUp 1000000
Timeout=TimePlaceDown 1000000
Timeout=TimePlaceUp 1000000
Timeout=TimePlace 500000

State=ST_TIMER
END

State=ST_HALT
END

State=ST_IDLE
	SET Lower 0
	SET Suck 0
	TEST parent = ST_RESET
		SET errorCode 0
    SETSTATE ST_RESET
  ENDTEST
END

State=ST_RESET
	SET errorCode 0
	TEST nextpalb = 1
		SET placefinito 1
		SET nextpalb 0
	ENDTEST
	TEST parent = ST_IDLE
  AND simCardboardOnly = 0
		SETSTATE ST_IDLE
	ELSETEST Servo = ST_CHOOSETRACK
		SET clearNext 0
    SET prenextcardboardlayer 0
		SETSTATE ST_BEGINHOME
	ENDTEST
END

State=ST_HOME
  CALC temp = cBItem + 1
	TEST parent = ST_IDLE
  AND simCardboardOnly = 0
		SETSTATE ST_IDLE
	ELSETEST nextcardboardlayer = 1
  OR simCardboardOnly = 1
		SET downstep 1
		SETSTATE ST_WAIT_SCISSORUP
	ELSETEST nextpalb = 1
		SET placefinito 1
		SET nextpalb 0
  ELSETEST robotprg = ST_CONVEYORB_PALLETB
  AND axis_t > 500000
  AND axis_t < 999000
  AND temp < wBItem
	AND scissorpick = ST_READY_ROBOT
    SET pickAndWaitNext 1
    SET Lower 1
	  SET Suck 1
	  SET tries 0
    TIMEOUT TimePickDown ST_PICKDOWN
	  SETSTATE ST_PICKDOWN
  ELSETEST scissorplace = ST_CENTRE_AND_REV
    SET pickAndWaitNext 0
    SET Lower 1
	  SET Suck 1
	  SET tries 0
    TIMEOUT TimePickDown ST_PICKDOWN
	  SETSTATE ST_PICKDOWN
	ENDTEST
END

State=ST_WAIT_SCISSORUP
	TEST upstep = 0
	AND scissorpick = ST_READY_ROBOT
    TEST scissorplace = ST_READY_ROBOT
    OR scissorplace = ST_SEARCH_EDGE
    OR scissorplace = ST_PRE_EDGEOFF
    OR scissorplace = ST_SEARCH_EDGEOFF
    OR scissorplace = ST_ONETIME_CENTRE
		  SET testcardboard 0
		  ;SETSTATE ST_BEGINPICK
      ;Home is posPick
      SET pickAndWaitNext 0
      SET Lower 1
	    SET Suck 1
	    SET tries 0
	    TEST testcardboard = 1
		    SET nextcardboardlayer 0
	    ENDTEST
	    TIMEOUT TimePickDown ST_PICKDOWN
	    SETSTATE ST_PICKDOWN
    ENDTEST
	ELSETEST parent = ST_IDLE
  AND simCardboardOnly = 0
		SETSTATE ST_IDLE
	ENDTEST
END

State=ST_BEGINHOME
  TEST Servo = ST_START
    SETSTATE ST_GOHOME
	ENDTEST
END

State=ST_GOHOME
  TEST curpm >= nextcurpm
  AND clearNext = 1
    SET nextcardboardlayer 0
  ENDTEST
  TEST Servo = ST_STOP
		TEST clearNext = 1
			SET clearNext 0
			SET nextcardboardlayer 0
		ENDTEST
		SETSTATE ST_HOME
  ELSETEST Servo = ST_IDLE
    SETSTATE ST_IDLE
	ENDTEST
END

State=ST_BEGINPICK
  TEST Servo = ST_START
    SETSTATE ST_GOPICK
  ENDTEST
END

State=ST_GOPICK
  TEST curpm >= nextcurpm
  AND testcardboard = 1
    SET nextcardboardlayer 0
  ENDTEST
  TEST Servo = ST_STOP
		SET Lower 1
		SET Suck 1
		SET tries 0
		TEST testcardboard = 1
			SET nextcardboardlayer 0
		ENDTEST
		TIMEOUT TimePickDown ST_PICKDOWN
		SETSTATE ST_PICKDOWN
  ELSETEST Servo = ST_IDLE
    SETSTATE ST_IDLE
	ENDTEST
END

State=ST_PICKDOWN
	TEST TimePickDown = 1
  OR ShuttleDown = 1
    TIMEOUT TimePick ST_PICK
		SETSTATE ST_PICK
	ENDTEST
END

State=ST_PICK
  TEST TimePick = 1
	  TEST testcardboard = 2
		  SET Lower 1
		  SET Suck 0
		  TIMEOUT TimePickUp ST_PICKUP_HOME
		  SETSTATE ST_PICKUP_HOME
	  ELSE
		  SET Lower 0
		  SET Suck 1
		  TIMEOUT TimePickUp ST_PICKUP
		  SETSTATE ST_PICKUP
	  ENDTEST
  ENDTEST
END

State=ST_PICKUP_HOME
	TEST TimePickUp = 1
	OR ShuttleUp = 1
    SET pickAndWaitNext 0
		SET Lower 0
		SET Suck 0
		SET testcardboard 0
		TEST nextcardboardlayer = 1
			SET downstep 1
			;SETSTATE ST_BEGINPICK
      SET Lower 1
	    SET Suck 1
	    SET tries 0
	    TEST testcardboard = 1
		    SET nextcardboardlayer 0
	    ENDTEST
	    TIMEOUT TimePickDown ST_PICKDOWN
	    SETSTATE ST_PICKDOWN
		ELSE
			SET clearNext 0
      SETSTATE ST_HOME
;			TIMEOUT TimePlaceUp ST_BEGINHOME
;			SETSTATE ST_TIMER
		ENDTEST
	ENDTEST
END

State=ST_GOIDLE
	SET Lower 0
	SET Suck 0
	TIMEOUT TimePlaceUp ST_IDLE
	SETSTATE ST_TIMER
END

State=ST_PICKUP
	TEST parent = ST_IDLE
  AND simCardboardOnly = 0
		SET Lower 1
		SET Suck 1
		TIMEOUT TimePlaceDown ST_GOIDLE
		SETSTATE ST_TIMER
	ELSETEST TimePickUp = 1
;	OR ShuttleUp = 1
; no ShuttleUp to let a possible second cardboard fall off before going to place
		TEST Photo = 1
      TEST pickAndWaitNext = 1
      AND nextcardboardlayer = 1
      OR pickAndWaitNext = 0
        TEST pickAndWaitNext = 1
          SET pickAndWaitNext 0
		      SET downstep 1
        ENDTEST
	      TEST testcardboard = 0
				  TEST downstep = 0
				  AND scissorplace = ST_READY_ROBOT
          OR downstep = 0
          AND scissorplace = ST_ONETIME_CENTRE
					  SET upstep 1
					  SET oneshot 0
					  SETSTATE ST_BEGINPLACE
				  ENDTEST
			  ELSE
				  SET testcardboard 2
				  SET Lower 1
				  SET Suck 1
				  SET tries 0
				  TIMEOUT TimePickDown ST_PICKDOWN
				  SETSTATE ST_PICKDOWN
			  ENDTEST
      ENDTEST
		ELSE
			CALC tries = tries + 1
			TEST tries >= maxtries
;				TEST testcardboard = 1
        TEST inTopPos = 1
          SET pickfinito 1
					SET Lower 0
					SET Suck 0
					SET testcardboard 0
					SET clearNext 0
					;TIMEOUT TimePlaceUp ST_BEGINHOME
					;SETSTATE ST_TIMER
          SETSTATE ST_HOME
				ELSETEST simCardboardOnly = 0
					SET errorCode 4201
					SETSTATE ST_IDLE
				ENDTEST
			ELSE
				SET Lower 1
				SET Suck 1
				TIMEOUT TimePickDown ST_PICKDOWN
				SETSTATE ST_PICKDOWN
			ENDTEST
		ENDTEST
	ENDTEST
END

State=ST_BEGINPLACE
	TEST oneshot = 0
	AND PhotoTest = 1
  AND Sclimitup = 1
		SET pickfinito 1
		SET oneshot 1
	ENDTEST
  TEST Servo = ST_START
    SETSTATE ST_GOPLACE
  ENDTEST
  TEST Photo = 0
  AND simCardboardOnly = 0
    SET errorCode 4201
		SETSTATE ST_IDLE
  ENDTEST
END

State=ST_GOPLACE
	TEST oneshot = 0
	AND PhotoTest = 1
  AND Sclimitup = 1
		SET pickfinito 1
		SET oneshot 1
	ENDTEST
  TEST Servo = ST_STOP
		SET Lower 1
    SET prenextcardboardlayer 1
		TIMEOUT TimePlaceDown ST_PLACEDOWN
		SETSTATE ST_PLACEDOWN
  ELSETEST Servo = ST_IDLE
    SETSTATE ST_IDLE
	ENDTEST
  TEST Photo = 0
  AND simCardboardOnly = 0
    SET errorCode 4201
		SETSTATE ST_IDLE
  ENDTEST
END

State=ST_PLACEDOWN
	TEST TimePlaceDown = 1
  OR ShuttleDown = 1
		SET Suck 0
		SET upstep 1
		TIMEOUT TimePlace ST_PLACE
		SETSTATE ST_PLACE
	ENDTEST
  TEST Photo = 0
  AND simCardboardOnly = 0
    SET errorCode 4201
		SETSTATE ST_IDLE
  ENDTEST
END

State=ST_PLACE
	TEST TimePlace = 1
		SET Suck 0
		SET Lower 0
		TIMEOUT TimePlaceUp ST_PLACEUP
		SETSTATE ST_PLACEUP
	ENDTEST
END

State=ST_PLACEUP
	TEST TimePlaceUp = 1
	OR ShuttleUp = 1
    ;TEST inTopPos = 1
      ;TEST upstep = 0
        ;SET testcardboard 1
        ;SETSTATE ST_BEGINPICK
       ;ENDTEST
     ;ELSE
     SET clearNext 1
		 SETSTATE ST_BEGINHOME
   ;ENDTEST
 ENDTEST
END
