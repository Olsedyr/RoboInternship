STATEMACHINEVERSION 3
Name=WorkCell
Link=Emergency
Link=ContinueKnap
Link=ErrorCode
; Statemachines with output, that should be tested for ST_IDLE
; find them with 'grep -l "Output=" 701*.statemachine'
Link=BufferPlads
Link=KasseInLiner
Link=KasseLoader1
Link=KasseLoader2
Link=LangBufferSkub
Link=ServoBuffer
Link=ServoLift
Link=ServoSkub
Link=ProductConveyors
Link=Vender2
Link=VendeStation2
linkValue=button2Pressed RemoteControl
linkValue=newprogram Program
Value=errorCode 0
Value=firstRun 0
Timeout=timeBeforeRunning 3000000
Timeout=timeBeforePausing 2000000

State=ST_HALT
END

State=ST_IDLE
  TEST ContinueKnap = ST_HIGH
    TIMEOUT timeBeforeRunning ST_STARTING
    SETSTATE ST_STARTING
  ENDTEST
END

State=ST_STARTING
  SET firstRun 1
	TEST timeBeforeRunning = 1
		SETSTATE ST_RUNNING
	ENDTEST
	TEST Emergency = ST_POWEROFF
		SET errorCode 203
		SETSTATE ST_ERROR
	ENDTEST
END

State=ST_RESTARTING
  SET firstRun 0
	TEST timeBeforeRunning = 1
		SETSTATE ST_RUNNING
	ENDTEST
	TEST Emergency = ST_POWEROFF
		SET errorCode 203
		SETSTATE ST_ERROR
	ENDTEST
END

State=ST_RUNNING
  TEST ContinueKnap = ST_HIGH
  OR button2Pressed = 1
    TIMEOUT timeBeforePausing ST_PAUSING
    SETSTATE ST_PAUSING
  ENDTEST
	TEST ErrorCode = ST_ERROR
		TIMEOUT timeBeforePausing ST_PAUSING
    SETSTATE ST_PAUSING
	ENDTEST
	TEST Emergency = ST_POWEROFF
		SET errorCode 203
		SETSTATE ST_ERROR
	ENDTEST
END

State=ST_STOPPING
  SETSTATE ST_IDLE
	TEST Emergency = ST_POWEROFF
		SET errorCode 203
		SETSTATE ST_ERROR
	ENDTEST
END

State=ST_PAUSING
	; dont test for trafficlight :-)
	TEST timeBeforePausing = 1
	AND BufferPlads = ST_IDLE
	AND KasseInLiner = ST_IDLE
	AND LangBufferSkub = ST_IDLE
	AND ServoBuffer = ST_IDLE
	AND ServoLift = ST_IDLE
	AND ServoSkub = ST_IDLE
	AND ProductConveyors = ST_IDLE
	AND Vender2 = ST_IDLE
	AND VendeStation2 = ST_IDLE
		TEST KasseLoader1 = ST_IDLE
		OR KasseLoader1 = ST_FREEZE
		OR KasseLoader1 = ST_HOLD
			TEST KasseLoader2 = ST_IDLE
			OR KasseLoader2 = ST_FREEZE
				SETSTATE ST_PAUSED
			ENDTEST
		ENDTEST
	ENDTEST
	TEST Emergency = ST_POWEROFF
		SET errorCode 203
		SETSTATE ST_ERROR
	ENDTEST
END

State=ST_PAUSED
	TEST newprogram = 1
		SETSTATE ST_IDLE
	ELSE
		TEST ContinueKnap = ST_HIGH
			TIMEOUT timeBeforeRunning ST_RESTARTING
			SETSTATE ST_RESTARTING
		ENDTEST
	ENDTEST
END

State=ST_ERROR
  TEST ContinueKnap = ST_HIGH
		SET errorCode 0
    TIMEOUT timeBeforeRunning ST_STARTING
    SETSTATE ST_STARTING
  ENDTEST
END

State=ST_RESET
END

State=ST_TIMER
END
