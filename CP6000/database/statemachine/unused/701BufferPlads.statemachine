STATEMACHINEVERSION 3
Name=BufferPlads
Input=kortskubindeleft "KortBufferSkub- Left"
Input=kortskubinderight "KortBufferSkub- Right"
Output=kortskub "KortBufferSkubber"
Link=KasseLift
Link=CamGen ServoBuffer
Link=CamGenSkub ServoSkub
Link=CamGenLift ServoLift
Link=Skubber LangBufferSkub
linkValue=firstRun WorkCell
linkValue=curpmskub curpm CamGenSkub
linkValue=liftFree CamGenLift
Const=KortSkubpm 900
Value=full 0
Value=startingup 0
Timeout=WaitKortSkub 100000
Timeout=TimeOpen 0

State=ST_TIMER
END

State=ST_HALT
END

State=ST_IDLE
	SET kortskub 0
	TEST Skubber = ST_RESET
		SETSTATE ST_RESET
	ENDTEST
END

State=ST_RESET
	TEST firstRun = 1
		SET full 0
	ENDTEST
	SET startingup 1
	SETSTATE ST_BEGINCLOSE
END

State=ST_STARTUP
	SET startingup 0
	TEST full = 0
		SETSTATE ST_WAITPUSH
	ELSE
		SET kortskub 1
		TIMEOUT WaitKortSkub ST_DUMP
		SETSTATE ST_DUMP
	ENDTEST
END

State=ST_WAITPUSH
  TEST Skubber = ST_FORWARD
		SETSTATE ST_GETPUSH
	ELSE
		TEST Skubber = ST_FORWARDSTAY
			SETSTATE ST_GETFULL
		ENDTEST
	ENDTEST
  TEST Skubber = ST_IDLE
    SETSTATE ST_IDLE
  ENDTEST
END

State=ST_GETPUSH
	TEST Skubber != ST_FORWARD
		SETSTATE ST_WAITPUSH
	ENDTEST
END

State=ST_GETFULL
	TEST curpmskub > KortSkubpm
		SET kortskub 1
	ENDTEST
	TEST Skubber = ST_STAY_FINISH
		SET full 1
		SET kortskub 1
		TIMEOUT WaitKortSkub ST_DUMP
		SETSTATE ST_DUMP
	ENDTEST
END

State=ST_DUMP
	TEST WaitKortSkub = 1
		TEST KasseLift = ST_READY2
			SETSTATE ST_BEGINOPEN
		ELSE
			TEST liftFree = 0
			AND KasseLift = ST_GO
				SETSTATE ST_BEGINOPEN
			ENDTEST
		ENDTEST
	ENDTEST
	TEST Skubber = ST_IDLE
		SETSTATE ST_IDLE
	ENDTEST
END

State=ST_BEGINOPEN
  TEST CamGen = ST_START
    SETSTATE ST_GOOPEN
	ELSE
		TEST Skubber = ST_IDLE
			SETSTATE ST_IDLE
		ENDTEST
  ENDTEST
END

State=ST_GOOPEN
	TEST CamGen = ST_STOP
		SET full 0
		SETSTATE ST_PREOPEN
	ENDTEST
END

State=ST_PREOPEN
	TEST KasseLift = ST_READY2
    TIMEOUT TimeOpen ST_OPEN
    SETSTATE ST_OPEN
  ENDTEST
END

State=ST_OPEN
	TEST TimeOpen = 1
		SETSTATE ST_EMPTIED
	ENDTEST
END

State=ST_EMPTIED
	TEST liftFree = 1
		SETSTATE ST_BEGINCLOSE
	ENDTEST
END

State=ST_BEGINCLOSE
	SET kortskub 0
	TEST CamGen = ST_START
    SETSTATE ST_GOCLOSE
	ELSE
		TEST Skubber = ST_IDLE
			SETSTATE ST_IDLE
		ENDTEST
  ENDTEST
END

State=ST_GOCLOSE
  TEST CamGen = ST_STOP
		SETSTATE ST_NEXT
  ENDTEST
END

State=ST_NEXT
	TEST kortskubindeleft = 1
	AND kortskubinderight = 1
  	TEST startingup = 0
			SETSTATE ST_WAITPUSH
		ELSE
			SETSTATE ST_STARTUP
		ENDTEST
	ENDTEST
END
