STATEMACHINEVERSION 3
Name=CamGenLift
Link=PID PIDLift
Link=Master KasseLift
Link=parent Parent
linkValue=encoder PID
linkValue=maxheight PID
linkValue=minheight PID
linkValue=poserr PID 
linkValue=inShake Master
linkValue=casekind Program
linkValue=liftMilliTime Program
linkValue=firstRun WorkCell
linkValue=pidstaticmode staticmode PID
Value=errorCode 0
Const=posHome 1350
;Const=posC11 11350
Const=posC11 10800
Const=posC14 10214
Const=posC18 8700
Const=posHubschA 9700
Const=posHubschB 5400
Const=posNetto 6900
Const=posEPS610 11500
Const=posIfcoLarge 7600
Const=posShake 2500
Const=posFree 2400
Value=tMilli 1400
Value=liftFree 1
Value=posf 0.0
Value=beginpos 0.0
Value=endpos 0.0
Value=beginspeed 0.0
Value=endspeed 0.0
Value=tTime 2000000
Value=setpoint 0
Value=setspeed 0
Value=xtot 0.0
Value=curpm 0.0
Value=curpos 0.0
Value=curt 0
Value=temp 0
Value=ga 0.0
Value=gb 0.0
Value=gc 0.0
Value=gd 0.0
Value=tcpm 0.0
Value=millitot 0.0
Value=goIdle 0
Value=beginning 0
Timeout=ttot 5000000
Timeout=TimeWaitIdle 1000000

; casekind = 0 -> none
; casekind = 1 -> C11
; casekind = 2 -> C18
; casekind = 3 -> hubschA
; casekind = 4 -> hubschB
; casekind = 5 -> Netto
; casekind = 6 -> EPS610
; casekind = 7 -> IFCOLarge
; casekind = 14 -> C14

State=ST_TIMER
END

State=ST_HALT
END

State=ST_IDLE
	TEST parent = ST_RESET
		SETSTATE ST_RESET
	ENDTEST
END

State=ST_RESET
	SET tMilli liftMilliTime
	SET setpoint posHome
	CALC posf = posC18 - posFree
  SETSTATE ST_NOCHOOSETRACK
END

State=ST_NOCHOOSETRACK
	SET setpoint encoder
	TEST PID = ST_RUN
		SETSTATE ST_CHOOSETRACK
	ENDTEST
END

State=ST_CHOOSETRACK
	SET beginspeed 0
	SET endspeed 0
  TEST PID = ST_RUN
  OR PID = ST_BRAKERELEASE_WAIT
    TEST Master = ST_BEGINHOME
			SET beginpos setpoint
      SET endpos posHome
			SETSTATE ST_PRESTART
    ELSE
      TEST Master = ST_BEGINHIGH
				SET beginpos setpoint
				TEST casekind = 1
					SET endpos posC11
					CALC posf = endpos - posFree
				ELSE
					TEST casekind = 2
						SET endpos posC18
						CALC posf = endpos - posFree
					ELSE
						TEST casekind = 3
							SET endpos posHubschA
							CALC posf = endpos - posFree
						ELSE
							TEST casekind = 4
								SET endpos posHubschB
								CALC posf = endpos - posFree
							ELSE
								TEST casekind = 5
									SET endpos posNetto
									CALC posf = endpos - posFree
								ELSE
									TEST casekind = 6
										SET endpos posEPS610
										CALC posf = endpos - posFree
									ELSE
										TEST casekind = 7
											SET endpos posIfcoLarge
											CALC posf = endpos - posFree
										ELSE
										  TEST casekind = 14
											  SET endpos posC14
  											CALC posf = endpos - posFree
	  									ELSE
		  									SET endpos posHome
			  							ENDTEST
										ENDTEST
									ENDTEST
								ENDTEST
							ENDTEST
						ENDTEST
					ENDTEST
				ENDTEST
				TEST inShake = 1
					CALC endpos = endpos - posShake
				ENDTEST
				SETSTATE ST_START
			ENDTEST
		ENDTEST
	ELSE
		SET setspeed 0
		SETSTATE ST_NOCHOOSETRACK
  ENDTEST
  TEST Master = ST_IDLE
		SET beginpos setpoint
		SET endpos posHome
    SET goIdle 1
		SETSTATE ST_PRESTART
  ENDTEST
	TEST encoder < posf
		SET liftFree 1
	ELSE
		SET liftFree 0
	ENDTEST
END

State=ST_STOP
  SET curpm 1000.0
  SET setpoint endpos
	SET setspeed 0
  SETSTATE ST_CHOOSETRACK
	TEST Master = ST_IDLE
	AND goIdle = 1
    SET goIdle 0
		TIMEOUT TimeWaitIdle ST_IDLE
		SETSTATE ST_TIMER
  ENDTEST
	TEST encoder < posf
		SET liftFree 1
	ELSE
		SET liftFree 0
	ENDTEST
END

State=ST_PRESTART
  TEST pidstaticmode = 1
    SET beginning 1
    SETSTATE ST_START_WAIT
  ELSE
    TEST PID = ST_BRAKERELEASE_WAIT
      SETSTATE ST_START_WAIT2
    ELSE
      SETSTATE ST_START
    ENDTEST
  ENDTEST
END

State=ST_START_WAIT
  TEST PID = ST_BRAKERELEASE_WAIT
    SETSTATE ST_START_WAIT2
  ENDTEST
END

State=ST_START_WAIT2
  SET beginpos encoder
  SET setpoint beginpos
  TEST PID = ST_RUN
    SET beginning 0
    SETSTATE ST_START
  ENDTEST
END

State=ST_START
  SET beginpos encoder
	CALC tTime = endpos - beginpos
	TEST tTime < 0
		CALC tTime = tTime * -1
	ENDTEST
	CALC tTime = tTime * 1000
	CALC temp = maxheight - minheight
	CALC tTime = tTime / temp
	; tMilli = 2500 -> 2.5 s for hele bevægelsen
	CALC tTime = tTime * tMilli
	SET ttot tTime
  SET setpoint beginpos
	SET setspeed 0
  CALC xtot = endpos - beginpos
  SET curpm 0.0
  TEST xtot < 100.0
  AND xtot > -100.0
		SET setpoint endpos
	  SETSTATE ST_STOP
  ELSE
		TIMEOUT ttot ST_RUN
		SETSTATE ST_RUN
  ENDTEST
END

; Profile that accelerates more in beginning
State=ST_RUN
  SET curt ttot
  CALC curt = ttot - curt
	CALC millitot = ttot / 1000.0
	CALC curpm = curt / millitot
	CALC curpos = 2000.0 * beginpos
	CALC tcpm = curpm - 1000.0
	CALC ga = tcpm * tcpm
	CALC gb = 500.0 + curpm
	CALC ga = ga * gb
	CALC curpos = curpos * ga
	CALC ga = curpm - 1500.0
  CALC ga = ga * curpm
	CALC ga = ga * endpos
	CALC ga = ga * -2000.0
	CALC gb = tcpm * millitot
	CALC gc = tcpm * beginspeed
	CALC gd = curpm * endspeed
	CALC gc = gc + gd
	CALC gb = gb * gc
	CALC ga = ga + gb
	CALC ga = ga * curpm
	CALC curpos = curpos + ga
	CALC curpos = curpos / 1000000000000.0
	SET setpoint curpos
	; ved samplerate på ca. 126 Hz
  TEST ttot < 3800
    SETSTATE ST_STOP
  ENDTEST
	TEST encoder < posf
		SET liftFree 1
	ELSE
		SET liftFree 0
	ENDTEST
END
